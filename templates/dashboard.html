<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Crypto Trading Bot</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000000;
            color: #ffffff;
            font-size: 12px;
            overflow-x: hidden;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #111111;
            border-bottom: 1px solid #333333;
        }

        .header h1 {
            font-size: 16px;
            color: #00ff00;
            font-weight: bold;
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 11px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00ff00;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .main-container {
            display: grid;
            grid-template-columns: 300px 1fr 280px;
            height: calc(100vh - 45px);
        }

        .left-panel, .right-panel {
            background: #111111;
            border-right: 1px solid #333333;
            overflow-y: auto;
        }

        .right-panel {
            border-right: none;
            border-left: 1px solid #333333;
        }

        .center-panel {
            background: #000000;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 8px 12px;
            background: #222222;
            border-bottom: 1px solid #333333;
            font-size: 11px;
            font-weight: bold;
            color: #00ff00;
            text-transform: uppercase;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #333333;
        }

        .stat-box {
            background: #111111;
            border: 1px solid #333333;
            padding: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 9px;
            color: #888888;
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .stat-value {
            font-size: 13px;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 2px;
        }

        .stat-change {
            font-size: 9px;
        }

        .positive { color: #00ff00; }
        .negative { color: #ff0000; }
        .neutral { color: #ffff00; }

        .signals-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .signals-header {
            padding: 8px 12px;
            background: #222222;
            border-bottom: 1px solid #333333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .refresh-btn {
            background: #333333;
            border: 1px solid #555555;
            color: #ffffff;
            padding: 4px 8px;
            font-size: 10px;
            cursor: pointer;
            font-family: inherit;
        }

        .refresh-btn:hover {
            background: #444444;
        }

        .signals-list {
            flex: 1;
            overflow-y: auto;
        }

        .signal-row {
            display: grid;
            grid-template-columns: 60px 60px 80px 80px 60px 60px;
            padding: 6px 8px;
            border-bottom: 1px solid #333333;
            font-size: 10px;
            align-items: center;
        }

        .signal-row:hover {
            background: #111111;
        }

        .signal-coin {
            font-weight: bold;
            color: #00ff00;
        }

        .direction-long { color: #00ff00; }
        .direction-short { color: #ff0000; }

        .price-cell {
            font-family: 'Courier New', monospace;
            text-align: right;
        }

        .pnl-cell {
            font-family: 'Courier New', monospace;
            text-align: right;
            font-weight: bold;
        }

        .confidence-cell {
            text-align: center;
        }

        .log-container {
            height: 200px;
            overflow-y: auto;
            background: #000000;
            border: 1px solid #333333;
            margin: 10px;
            font-size: 10px;
        }

        .log-entry {
            padding: 3px 8px;
            border-bottom: 1px solid #1a1a1a;
            font-family: 'Courier New', monospace;
        }

        .log-timestamp {
            color: #888888;
        }

        .log-level-INFO { color: #00ff00; }
        .log-level-DEBUG { color: #888888; }
        .log-level-WARNING { color: #ffff00; }
        .log-level-ERROR { color: #ff0000; }

        .log-component {
            color: #00ffff;
        }

        .log-message {
            color: #ffffff;
        }

        .portfolio-section {
            margin: 10px;
        }

        .portfolio-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            border-bottom: 1px solid #333333;
            font-size: 10px;
        }

        .analysis-section {
            margin: 10px;
        }

        .analysis-item {
            padding: 4px 8px;
            border-bottom: 1px solid #333333;
            font-size: 10px;
        }

        .coin-name {
            color: #00ff00;
            font-weight: bold;
        }

        .analysis-count {
            color: #ffff00;
        }

        .market-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
            margin: 10px;
        }

        .market-stat {
            background: #111111;
            border: 1px solid #333333;
            padding: 5px;
            text-align: center;
            font-size: 9px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #111111;
            border: 2px solid #333333;
            width: 90%;
            max-width: 1200px;
            height: 80%;
            overflow-y: auto;
        }

        .modal-header {
            padding: 10px 15px;
            background: #222222;
            border-bottom: 1px solid #333333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 16px;
            cursor: pointer;
            font-family: inherit;
        }

        .chart-container {
            height: 400px;
            margin: 10px;
            border: 1px solid #333333;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px;
        }

        .analysis-card {
            background: #000000;
            border: 1px solid #333333;
            padding: 10px;
        }

        .analysis-card h4 {
            color: #00ff00;
            font-size: 11px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .no-signals {
            text-align: center;
            padding: 40px 20px;
            color: #888888;
            font-size: 11px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #888888;
            font-size: 10px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #333333;
            border-left: 2px solid #00ff00;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .scrollbar::-webkit-scrollbar-track {
            background: #000000;
        }

        .scrollbar::-webkit-scrollbar-thumb {
            background: #333333;
            border-radius: 4px;
        }

        .scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555555;
        }

        .signals-list, .log-container, .left-panel, .right-panel {
            scrollbar-width: thin;
            scrollbar-color: #333333 #000000;
        }

        .trading-pair-list {
            margin: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .trading-pair {
            display: flex;
            justify-content: space-between;
            padding: 2px 8px;
            font-size: 9px;
            border-bottom: 1px solid #222222;
        }

        .pair-name {
            color: #00ff00;
        }

        .pair-price {
            color: #ffffff;
        }

        .pair-change {
            font-weight: bold;
        }

        .system-info {
            margin: 10px;
            background: #111111;
            border: 1px solid #333333;
            padding: 8px;
        }

        .system-row {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            padding: 1px 0;
        }

        .system-label {
            color: #888888;
        }

        .system-value {
            color: #ffffff;
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 250px 1fr 250px;
            }
        }

        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
            
            .left-panel, .right-panel {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>CRYPTO TRADING BOT v2.1</h1>
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot"></div>
                <span id="bot-status">ACTIVE</span>
            </div>
            <div class="status-item">
                <span>UPTIME:</span>
                <span id="uptime">00:00:00</span>
            </div>
            <div class="status-item">
                <span>SCANS:</span>
                <span id="scan-count">0</span>
            </div>
            <div class="status-item">
                <span>LAST:</span>
                <span id="last-update">--:--:--</span>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- Left Panel -->
        <div class="left-panel scrollbar">
            <div class="panel-header">Portfolio Stats</div>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Balance</div>
                    <div class="stat-value" id="portfolio-balance">$1,000.00</div>
                    <div class="stat-change" id="portfolio-change">+0.00%</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Active</div>
                    <div class="stat-value" id="active-signals">0</div>
                    <div class="stat-change" id="total-signals">Total: 0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Win Rate</div>
                    <div class="stat-value" id="win-rate">0%</div>
                    <div class="stat-change" id="total-trades">0 trades</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">P&L</div>
                    <div class="stat-value" id="daily-pnl">$0.00</div>
                    <div class="stat-change" id="daily-change">0.00%</div>
                </div>
            </div>

            <div class="panel-header">Portfolio Details</div>
            <div class="portfolio-section">
                <div class="portfolio-item">
                    <span>Best Trade:</span>
                    <span id="best-trade" class="positive">$0.00</span>
                </div>
                <div class="portfolio-item">
                    <span>Worst Trade:</span>
                    <span id="worst-trade" class="negative">$0.00</span>
                </div>
                <div class="portfolio-item">
                    <span>Avg Trade:</span>
                    <span id="avg-trade" class="neutral">$0.00</span>
                </div>
                <div class="portfolio-item">
                    <span>Open P&L:</span>
                    <span id="open-pnl" class="neutral">$0.00</span>
                </div>
                <div class="portfolio-item">
                    <span>Max Drawdown:</span>
                    <span id="max-drawdown" class="negative">$0.00</span>
                </div>
                <div class="portfolio-item">
                    <span>Profit Factor:</span>
                    <span id="profit-factor" class="neutral">0.00</span>
                </div>
            </div>

            <div class="panel-header">Market Overview</div>
            <div class="market-stats">
                <div class="market-stat">
                    <div class="stat-label">Bullish</div>
                    <div class="stat-value positive" id="bullish-count">0</div>
                </div>
                <div class="market-stat">
                    <div class="stat-label">Bearish</div>
                    <div class="stat-value negative" id="bearish-count">0</div>
                </div>
                <div class="market-stat">
                    <div class="stat-label">Neutral</div>
                    <div class="stat-value neutral" id="neutral-count">0</div>
                </div>
            </div>

            <div class="panel-header">System Info</div>
            <div class="system-info">
                <div class="system-row">
                    <span class="system-label">CPU:</span>
                    <span class="system-value" id="cpu-usage">---%</span>
                </div>
                <div class="system-row">
                    <span class="system-label">Memory:</span>
                    <span class="system-value" id="memory-usage">---%</span>
                </div>
                <div class="system-row">
                    <span class="system-label">Network:</span>
                    <span class="system-value" id="network-status">CONNECTED</span>
                </div>
                <div class="system-row">
                    <span class="system-label">Exchange:</span>
                    <span class="system-value" id="exchange-status">BINANCE</span>
                </div>
                <div class="system-row">
                    <span class="system-label">Latency:</span>
                    <span class="system-value" id="latency">--- ms</span>
                </div>
            </div>
        </div>

        <!-- Center Panel -->
        <div class="center-panel">
            <div class="signals-section">
                <div class="signals-header">
                    <span style="font-size: 11px; font-weight: bold; color: #00ff00;">ACTIVE SIGNALS</span>
                    <button class="refresh-btn" onclick="refreshData()">REFRESH</button>
                </div>
                
                <div style="display: grid; grid-template-columns: 60px 60px 80px 80px 60px 60px; padding: 8px; background: #222222; border-bottom: 1px solid #333333; font-size: 9px; font-weight: bold; color: #888888;">
                    <div>COIN</div>
                    <div>DIR</div>
                    <div>ENTRY</div>
                    <div>CURRENT</div>
                    <div>P&L</div>
                    <div>CONF</div>
                </div>
                
                <div class="signals-list scrollbar" id="signals-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading signals...
                    </div>
                </div>
            </div>

            <div class="panel-header">Bot Activity Log</div>
            <div class="log-container scrollbar" id="log-container">
                <div class="log-entry">
                    <span class="log-timestamp">[--:--:--]</span>
                    <span class="log-level-INFO">[INFO]</span>
                    <span class="log-component">[SYSTEM]</span>
                    <span class="log-message">Bot initializing...</span>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel scrollbar">
            <div class="panel-header">Analysis Summary</div>
            <div class="analysis-section" id="analysis-summary">
                <div class="analysis-item">
                    <div style="color: #888888; font-size: 9px;">No analysis data available</div>
                </div>
            </div>

            <div class="panel-header">Monitored Pairs</div>
            <div class="trading-pair-list scrollbar" id="trading-pairs">
                <div class="trading-pair">
                    <span class="pair-name">BTC/USDT</span>
                    <span class="pair-price">$---.--</span>
                    <span class="pair-change neutral">--.--</span>
                </div>
            </div>

            <div class="panel-header">Recent Alerts</div>
            <div class="analysis-section" id="recent-alerts">
                <div class="analysis-item">
                    <div style="color: #888888; font-size: 9px;">No alerts</div>
                </div>
            </div>

            <div class="panel-header">Performance Metrics</div>
            <div class="analysis-section">
                <div class="analysis-item">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Sharpe Ratio:</span>
                        <span id="sharpe-ratio" class="neutral">0.00</span>
                    </div>
                </div>
                <div class="analysis-item">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Win Streak:</span>
                        <span id="win-streak" class="positive">0</span>
                    </div>
                </div>
                <div class="analysis-item">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Lose Streak:</span>
                        <span id="lose-streak" class="negative">0</span>
                    </div>
                </div>
                <div class="analysis-item">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Avg Hold:</span>
                        <span id="avg-hold" class="neutral">0h 0m</span>
                    </div>
                </div>
                <div class="analysis-item">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Success Rate:</span>
                        <span id="success-rate" class="neutral">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Modal -->
    <div id="chart-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modal-title" style="color: #00ff00; font-weight: bold;">CHART ANALYSIS</span>
                <button class="close-btn" onclick="closeModal()">[X]</button>
            </div>
            <div class="chart-container" id="chart-container"></div>
            <div class="analysis-grid" id="analysis-details">
                <div class="analysis-card">
                    <h4>Technical Indicators</h4>
                    <div id="indicators-data" style="font-size: 10px; color: #ffffff;"></div>
                </div>
                <div class="analysis-card">
                    <h4>Signal Analysis</h4>
                    <div id="signal-analysis" style="font-size: 10px; color: #ffffff;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let chart;
        let currentSignals = [];
        let startTime = new Date();
        let scanCount = 0;
        let logBuffer = [];

        // Initialize WebSocket connection
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                console.log('WebSocket connected');
                addLogEntry('INFO', 'WEBSOCKET', 'Connection established');
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function(event) {
                console.log('WebSocket disconnected');
                addLogEntry('WARNING', 'WEBSOCKET', 'Connection lost, reconnecting...');
                setTimeout(initWebSocket, 5000);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                addLogEntry('ERROR', 'WEBSOCKET', 'Connection error');
            };
        }

        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'update':
                    updateDashboard(data);
                    break;
                case 'new_signal':
                    addLogEntry('INFO', 'SIGNAL', `New ${data.signal.direction} signal: ${data.signal.coin}`);
                    refreshData();
                    break;
                case 'signal_closed':
                    addLogEntry('INFO', 'SIGNAL', `Signal closed: ${data.exit_reason}`);
                    refreshData();
                    break;
                case 'log':
                    addLogEntry(data.level, data.component, data.message);
                    break;
            }
        }

        function addLogEntry(level, component, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-level-${level}">[${level}]</span>
                <span class="log-component">[${component}]</span>
                <span class="log-message">${message}</span>
            `;
            
            const logContainer = document.getElementById('log-container');
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            // Keep only last 100 entries
            while (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.lastChild);
            }
            
            // Update last update time
            document.getElementById('last-update').textContent = timestamp;
        }

        function updateUptime() {
            const now = new Date();
            const diff = now - startTime;
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            
            document.getElementById('uptime').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        async function refreshData() {
            try {
                addLogEntry('DEBUG', 'SYSTEM', 'Refreshing dashboard data...');
                
                const [signalsResponse, portfolioResponse, logsResponse] = await Promise.all([
                    fetch('/api/signals'),
                    fetch('/api/portfolio'),
                    fetch('/api/logs')
                ]);
                
                const signalsData = await signalsResponse.json();
                const portfolioData = await portfolioResponse.json();
                const logsData = await logsResponse.json();
                
                currentSignals = signalsData.signals;
                updatePortfolioStats(portfolioData.portfolio);
                updateSignalsDisplay(currentSignals);
                updateLogsDisplay(logsData.logs);
                updateAnalysisSummary(logsData.analysis_summary);
                
                scanCount++;
                document.getElementById('scan-count').textContent = scanCount;
                
                addLogEntry('DEBUG', 'SYSTEM', 'Data refresh completed');
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                addLogEntry('ERROR', 'SYSTEM', 'Failed to refresh data');
            }
        }

        function updatePortfolioStats(portfolio) {
            document.getElementById('portfolio-balance').textContent = `${portfolio.total_balance.toFixed(2)}`;
            
            const change = portfolio.total_pnl;
            const changePercent = ((change / 1000) * 100).toFixed(2);
            const changeElement = document.getElementById('portfolio-change');
            changeElement.textContent = `${change >= 0 ? '+' : ''}${changePercent}%`;
            changeElement.className = `stat-change ${change >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('active-signals').textContent = currentSignals.length;
            document.getElementById('total-signals').textContent = `Total: ${portfolio.total_trades}`;
            
            document.getElementById('win-rate').textContent = `${portfolio.win_rate.toFixed(1)}%`;
            document.getElementById('total-trades').textContent = `${portfolio.total_trades} trades`;
            
            document.getElementById('daily-pnl').textContent = `${change.toFixed(2)}`;
            document.getElementById('daily-change').textContent = `${changePercent}%`;
            
            // Update portfolio details
            document.getElementById('best-trade').textContent = `${portfolio.best_trade.toFixed(2)}`;
            document.getElementById('worst-trade').textContent = `${portfolio.worst_trade.toFixed(2)}`;
            document.getElementById('avg-trade').textContent = `${portfolio.avg_pnl.toFixed(2)}`;
            document.getElementById('open-pnl').textContent = `${portfolio.open_pnl.toFixed(2)}`;
        }

        function updateSignalsDisplay(signals) {
            const container = document.getElementById('signals-container');
            
            if (signals.length === 0) {
                container.innerHTML = `
                    <div class="no-signals">
                        NO ACTIVE SIGNALS<br>
                        Bot scanning for opportunities...
                    </div>
                `;
                return;
            }
            
            container.innerHTML = signals.map(signal => `
                <div class="signal-row" onclick="showChart('${signal.coin}', '${signal.signal_id}')">
                    <div class="signal-coin">${signal.coin}</div>
                    <div class="direction-${signal.direction.toLowerCase()}">${signal.direction}</div>
                    <div class="price-cell">${signal.entry_price.toFixed(4)}</div>
                    <div class="price-cell">${signal.current_price.toFixed(4)}</div>
                    <div class="pnl-cell ${signal.pnl_usd >= 0 ? 'positive' : 'negative'}">
                        ${signal.pnl_usd.toFixed(2)}<br>
                        <small>${signal.pnl_percentage.toFixed(1)}%</small>
                    </div>
                    <div class="confidence-cell">${signal.confidence}%</div>
                </div>
            `).join('');
        }

        function updateLogsDisplay(logs) {
            if (!logs || logs.length === 0) return;
            
            const logContainer = document.getElementById('log-container');
            
            // Clear old logs and add new ones
            logContainer.innerHTML = '';
            
            logs.slice(0, 50).forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                
                const timestamp = new Date(log.timestamp).toLocaleTimeString();
                logEntry.innerHTML = `
                    <span class="log-timestamp">[${timestamp}]</span>
                    <span class="log-level-${log.level}">[${log.level}]</span>
                    <span class="log-component">[${log.component}]</span>
                    <span class="log-message">${log.message}</span>
                `;
                
                logContainer.appendChild(logEntry);
            });
        }

        function updateAnalysisSummary(summary) {
            if (!summary) return;
            
            const container = document.getElementById('analysis-summary');
            
            if (Object.keys(summary).length === 0) {
                container.innerHTML = '<div class="analysis-item"><div style="color: #888888; font-size: 9px;">No analysis data available</div></div>';
                return;
            }
            
            container.innerHTML = Object.entries(summary).map(([coin, data]) => `
                <div class="analysis-item">
                    <div class="coin-name">${coin}</div>
                    <div style="font-size: 9px; color: #888888;">
                        Analyses: <span class="analysis-count">${data.analysis_count}</span><br>
                        Bullish: <span class="positive">${data.bullish_signals}</span> 
                        Bearish: <span class="negative">${data.bearish_signals}</span><br>
                        Confidence: <span class="neutral">${data.avg_confidence.toFixed(1)}%</span>
                    </div>
                </div>
            `).join('');
        }

        async function showChart(coin, signalId) {
            const modal = document.getElementById('chart-modal');
            const title = document.getElementById('modal-title');
            const chartContainer = document.getElementById('chart-container');
            
            title.textContent = `${coin} ANALYSIS`;
            modal.style.display = 'block';
            
            chartContainer.innerHTML = '<div class="loading"><div class="spinner"></div>Loading chart...</div>';
            
            try {
                const response = await fetch(`/api/chart/${coin}`);
                const data = await response.json();
                
                if (data.error) {
                    chartContainer.innerHTML = `<div class="no-signals">ERROR: ${data.error}</div>`;
                    return;
                }
                
                chartContainer.innerHTML = '';
                
                chart = LightweightCharts.createChart(chartContainer, {
                    width: chartContainer.clientWidth,
                    height: 400,
                    layout: {
                        backgroundColor: '#000000',
                        textColor: '#ffffff',
                    },
                    grid: {
                        vertLines: { color: '#333333' },
                        horzLines: { color: '#333333' },
                    },
                    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                    rightPriceScale: { borderColor: '#333333' },
                    timeScale: { borderColor: '#333333' },
                });
                
                const candlestickSeries = chart.addCandlestickSeries({
                    upColor: '#00ff00',
                    downColor: '#ff0000',
                    borderDownColor: '#ff0000',
                    borderUpColor: '#00ff00',
                    wickDownColor: '#ff0000',
                    wickUpColor: '#00ff00',
                });
                
                const candleData = data.timestamps.map((time, index) => ({
                    time: new Date(time).getTime() / 1000,
                    open: data.prices.open[index],
                    high: data.prices.high[index],
                    low: data.prices.low[index],
                    close: data.prices.close[index],
                }));
                
                candlestickSeries.setData(candleData);
                
                const signal = currentSignals.find(s => s.signal_id === signalId);
                updateAnalysisDetails(signal, data);
                
            } catch (error) {
                console.error('Error loading chart:', error);
                chartContainer.innerHTML = '<div class="no-signals">ERROR loading chart data</div>';
            }
        }

        function updateAnalysisDetails(signal, chartData) {
            const indicatorsData = document.getElementById('indicators-data');
            const signalAnalysis = document.getElementById('signal-analysis');
            
            if (signal) {
                indicatorsData.innerHTML = `
                    RSI: ${signal.indicators.rsi}<br>
                    MACD: ${signal.indicators.macd.toFixed(6)}<br>
                    BB Position: ${signal.indicators.bb_position}<br>
                    Volume Ratio: ${signal.indicators.volume_ratio}<br>
                    ATR: ${signal.indicators.atr.toFixed(6)}
                `;
                
                signalAnalysis.innerHTML = `
                    Confidence: ${signal.confidence}%<br>
                    Direction: ${signal.direction}<br>
                    Risk/Reward: ${signal.analysis_data.risk_reward_ratio}<br>
                    <br>
                    Reasons:<br>
                    ${signal.analysis_data.reasons.map(reason => `• ${reason}`).join('<br>')}
                `;
            }
        }

        function closeModal() {
            const modal = document.getElementById('chart-modal');
            modal.style.display = 'none';
            if (chart) {
                chart.remove();
                chart = null;
            }
        }

        window.onclick = function(event) {
            const modal = document.getElementById('chart-modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            addLogEntry('INFO', 'SYSTEM', 'Dashboard initialized');
            initWebSocket();
            refreshData();
            
            // Update counters
            setInterval(updateUptime, 1000);
            setInterval(refreshData, 30000);
            
            // Simulate some system stats
            setInterval(() => {
                document.getElementById('cpu-usage').textContent = `${(Math.random() * 20 + 10).toFixed(1)}%`;
                document.getElementById('memory-usage').textContent = `${(Math.random() * 30 + 40).toFixed(1)}%`;
                document.getElementById('latency').textContent = `${Math.floor(Math.random() * 50 + 20)} ms`;
            }, 5000);
        });

        window.addEventListener('resize', function() {
            if (chart) {
                chart.applyOptions({
                    width: document.getElementById('chart-container').clientWidth,
                });
            }
        });
    </script>
</body>
</html>