<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ML Crypto Trading Bot v3.0</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --bg-primary: #0a0a0a;
        --bg-secondary: #141414;
        --bg-tertiary: #1a1a1a;
        --border-color: #2a2a2a;
        --text-primary: #ffffff;
        --text-secondary: #a0a0a0;
        --accent-green: #00ff88;
        --accent-red: #ff3366;
        --accent-yellow: #ffaa00;
        --accent-blue: #00aaff;
        --accent-purple: #8b5cf6;
      }

      body {
        font-family: "SF Mono", "Monaco", "Inconsolata", "Fira Code", monospace;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-size: 13px;
        overflow-x: hidden;
        line-height: 1.4;
      }

      /* Header */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: linear-gradient(
          90deg,
          var(--bg-secondary) 0%,
          var(--bg-tertiary) 100%
        );
        border-bottom: 2px solid var(--border-color);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
      }

      .header h1 {
        font-size: 18px;
        color: var(--accent-purple);
        font-weight: 600;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .ml-badge {
        background: linear-gradient(
          135deg,
          var(--accent-purple),
          var(--accent-blue)
        );
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 9px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-bar {
        display: flex;
        align-items: center;
        gap: 20px;
        font-size: 12px;
      }

      .status-item {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 4px;
        border: 1px solid var(--border-color);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--accent-green);
        animation: pulse 2s infinite;
      }

      .status-dot.training {
        background: var(--accent-purple);
        animation: pulse 1s infinite;
      }

      .status-dot.scanning {
        background: var(--accent-blue);
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7);
        }
        50% {
          opacity: 0.6;
          box-shadow: 0 0 0 6px rgba(0, 255, 136, 0);
        }
      }

      /* Main Layout */
      .main-container {
        display: grid;
        grid-template-columns: 320px 1fr 300px;
        height: calc(100vh - 60px);
        gap: 1px;
        background: var(--border-color);
      }

      .panel {
        background: var(--bg-secondary);
        overflow-y: auto;
        overflow-x: hidden;
      }

      .panel-header {
        padding: 10px 15px;
        background: linear-gradient(
          90deg,
          var(--bg-tertiary) 0%,
          var(--bg-secondary) 100%
        );
        border-bottom: 1px solid var(--border-color);
        font-size: 11px;
        font-weight: 600;
        color: var(--accent-green);
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .panel-header.ml-header {
        color: var(--accent-purple);
      }

      /* Stats Cards */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        padding: 15px;
      }

      .stat-card {
        background: linear-gradient(
          135deg,
          var(--bg-tertiary) 0%,
          var(--bg-primary) 100%
        );
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 12px;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 255, 136, 0.1);
        border-color: var(--accent-green);
      }

      .stat-card.ml-card {
        border-color: rgba(139, 92, 246, 0.3);
      }

      .stat-card.ml-card:hover {
        border-color: var(--accent-purple);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1);
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(
          90deg,
          transparent,
          var(--accent-green),
          transparent
        );
        animation: scan 3s linear infinite;
      }

      .stat-card.ml-card::before {
        background: linear-gradient(
          90deg,
          transparent,
          var(--accent-purple),
          transparent
        );
      }

      @keyframes scan {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      .stat-label {
        font-size: 10px;
        color: var(--text-secondary);
        text-transform: uppercase;
        margin-bottom: 5px;
        letter-spacing: 0.5px;
      }

      .stat-value {
        font-size: 18px;
        font-weight: bold;
        color: var(--text-primary);
        margin-bottom: 3px;
      }

      .stat-change {
        font-size: 11px;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      /* Color Classes */
      .positive {
        color: var(--accent-green);
      }
      .negative {
        color: var(--accent-red);
      }
      .neutral {
        color: var(--accent-yellow);
      }
      .ml-accent {
        color: var(--accent-purple);
      }

      /* Signals Section */
      .signals-container {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .signals-table {
        width: 100%;
        border-collapse: collapse;
      }

      .signals-table thead {
        background: var(--bg-tertiary);
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .signals-table th {
        padding: 10px;
        text-align: left;
        font-size: 10px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 1px;
        border-bottom: 2px solid var(--border-color);
      }

      .signals-table tbody tr {
        border-bottom: 1px solid var(--border-color);
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .signals-table tbody tr:hover {
        background: rgba(0, 255, 136, 0.05);
      }

      .signals-table tbody tr.ml-signal:hover {
        background: rgba(139, 92, 246, 0.05);
      }

      .signals-table td {
        padding: 12px 10px;
        font-size: 12px;
      }

      .signal-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-weight: 600;
        font-size: 10px;
        text-transform: uppercase;
      }

      .badge-long {
        background: rgba(0, 255, 136, 0.2);
        color: var(--accent-green);
        border: 1px solid var(--accent-green);
      }

      .badge-short {
        background: rgba(255, 51, 102, 0.2);
        color: var(--accent-red);
        border: 1px solid var(--accent-red);
      }

      .ml-confidence-badge {
        background: rgba(139, 92, 246, 0.2);
        color: var(--accent-purple);
        border: 1px solid var(--accent-purple);
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 9px;
        font-weight: 600;
      }

      /* Progress Bars */
      .progress-bar {
        width: 100%;
        height: 4px;
        background: var(--bg-tertiary);
        border-radius: 2px;
        overflow: hidden;
        margin-top: 4px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--accent-green),
          var(--accent-blue)
        );
        transition: width 0.3s ease;
      }

      /* Feature Importance */
      .feature-importance {
        margin-top: 8px;
        padding: 8px;
        background: rgba(139, 92, 246, 0.1);
        border-radius: 4px;
        border: 1px solid rgba(139, 92, 246, 0.2);
      }

      .feature-tag {
        display: inline-block;
        background: rgba(139, 92, 246, 0.2);
        color: var(--accent-purple);
        padding: 2px 6px;
        margin: 2px;
        border-radius: 3px;
        font-size: 9px;
        font-weight: 600;
      }

      /* Logs */
      .log-container {
        max-height: 250px;
        overflow-y: auto;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        margin: 15px;
        padding: 10px;
        font-family: monospace;
        font-size: 11px;
      }

      .log-entry {
        padding: 4px 0;
        border-bottom: 1px solid rgba(42, 42, 42, 0.5);
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .log-timestamp {
        color: var(--text-secondary);
        font-size: 10px;
      }

      .log-level {
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 9px;
        font-weight: 600;
      }

      .log-INFO {
        background: rgba(0, 255, 136, 0.2);
        color: var(--accent-green);
      }
      .log-WARNING {
        background: rgba(255, 170, 0, 0.2);
        color: var(--accent-yellow);
      }
      .log-ERROR {
        background: rgba(255, 51, 102, 0.2);
        color: var(--accent-red);
      }

      /* Buttons */
      .btn {
        padding: 8px 16px;
        background: linear-gradient(
          135deg,
          var(--accent-green),
          var(--accent-blue)
        );
        border: none;
        border-radius: 4px;
        color: var(--bg-primary);
        font-weight: 600;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn.ml-btn {
        background: linear-gradient(
          135deg,
          var(--accent-purple),
          var(--accent-blue)
        );
      }

      .btn.ml-btn:hover {
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.3;
      }

      /* Loading Spinner */
      .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid var(--border-color);
        border-left-color: var(--accent-green);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* ML Model Status */
      .model-status {
        padding: 15px;
        background: rgba(139, 92, 246, 0.05);
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: 8px;
        margin: 15px;
      }

      .model-metric {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
        font-size: 11px;
      }

      .model-metric .label {
        color: var(--text-secondary);
      }

      .model-metric .value {
        color: var(--accent-purple);
        font-weight: 600;
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: var(--bg-primary);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
      }

      /* Responsive */
      @media (max-width: 1200px) {
        .main-container {
          grid-template-columns: 280px 1fr 260px;
        }
      }

      @media (max-width: 900px) {
        .main-container {
          grid-template-columns: 1fr;
          grid-template-rows: auto 1fr auto;
        }
      }

      /* Animations */
      .fade-in {
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Chart Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        animation: fadeIn 0.3s ease;
      }

      .modal-content {
        position: relative;
        background: var(--bg-secondary);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        width: 90%;
        max-width: 1200px;
        height: 80%;
        margin: 5% auto;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
      }

      .modal-header {
        padding: 15px 20px;
        background: var(--bg-tertiary);
        border-bottom: 2px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .close-btn {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 24px;
        cursor: pointer;
        transition: color 0.3s ease;
      }

      .close-btn:hover {
        color: var(--accent-red);
      }

      .chart-container {
        height: 60%;
        background: var(--bg-primary);
      }

      .modal-tabs {
        display: flex;
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-color);
      }

      .modal-tab {
        flex: 1;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .modal-tab.active {
        background: var(--bg-secondary);
        color: var(--accent-purple);
      }

      .modal-tab:hover {
        background: var(--bg-secondary);
      }

      .tab-content {
        display: none;
        padding: 20px;
        height: calc(40% - 60px);
        overflow-y: auto;
      }

      .tab-content.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>
        <span style="font-size: 24px">üß†</span>
        ML CRYPTO TRADING BOT v3.0
        <span class="ml-badge">Machine Learning</span>
      </h1>
      <div class="status-bar">
        <div class="status-item">
          <div class="status-dot" id="main-status-dot"></div>
          <span id="bot-status">ACTIVE</span>
        </div>
        <div class="status-item">
          <span>MODELS:</span>
          <span id="models-count" style="color: var(--accent-purple)">0</span>
        </div>
        <div class="status-item">
          <span>UPTIME:</span>
          <span id="uptime" style="color: var(--accent-green)">00:00:00</span>
        </div>
        <div class="status-item">
          <span>SCANS:</span>
          <span id="scan-count" style="color: var(--accent-blue)">0</span>
        </div>
        <div class="status-item">
          <span>LAST UPDATE:</span>
          <span id="last-update" style="color: var(--accent-yellow)"
            >--:--:--</span
          >
        </div>
      </div>
    </div>

    <div class="main-container">
      <!-- Left Panel - Portfolio Stats -->
      <div class="panel">
        <div class="panel-header">
          <span>üìä PORTFOLIO OVERVIEW</span>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total Balance</div>
            <div class="stat-value" id="portfolio-balance">$1,000.00</div>
            <div class="stat-change" id="portfolio-change-container">
              <span id="portfolio-change">+0.00%</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Active Signals</div>
            <div class="stat-value" id="active-signals">0</div>
            <div class="stat-change neutral" id="total-signals">Total: 0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Win Rate</div>
            <div class="stat-value" id="win-rate">0.0%</div>
            <div class="stat-change" id="win-loss-ratio">W: 0 / L: 0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total P&L</div>
            <div class="stat-value" id="total-pnl">$0.00</div>
            <div class="stat-change" id="pnl-percentage">0.00%</div>
          </div>
        </div>

        <div class="panel-header ml-header">
          <span>üß† ML PERFORMANCE</span>
        </div>
        <div class="stats-grid">
          <div class="stat-card ml-card">
            <div class="stat-label">Model Accuracy</div>
            <div class="stat-value ml-accent" id="ml-accuracy">0.0%</div>
            <div class="stat-change neutral" id="prediction-count">
              Predictions: 0
            </div>
          </div>
          <div class="stat-card ml-card">
            <div class="stat-label">Avg Confidence</div>
            <div class="stat-value ml-accent" id="avg-confidence">0.0%</div>
            <div class="stat-change neutral" id="model-type">Ensemble</div>
          </div>
          <div class="stat-card ml-card">
            <div class="stat-label">Feature Quality</div>
            <div class="stat-value ml-accent" id="feature-quality">0.0%</div>
            <div class="stat-change neutral" id="orthogonality">
              Orthogonal: 0%
            </div>
          </div>
          <div class="stat-card ml-card">
            <div class="stat-label">Sharpe Ratio</div>
            <div class="stat-value ml-accent" id="sharpe-ratio">0.00</div>
            <div class="stat-change neutral" id="training-status">
              Training: Idle
            </div>
          </div>
        </div>

        <div class="panel-header">
          <span>üìà PERFORMANCE METRICS</span>
        </div>
        <div style="padding: 15px">
          <div
            style="
              display: flex;
              justify-content: space-between;
              padding: 8px 0;
              border-bottom: 1px solid var(--border-color);
            "
          >
            <span style="color: var(--text-secondary)">Best Trade:</span>
            <span id="best-trade" class="positive">$0.00</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              padding: 8px 0;
              border-bottom: 1px solid var(--border-color);
            "
          >
            <span style="color: var(--text-secondary)">Worst Trade:</span>
            <span id="worst-trade" class="negative">$0.00</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              padding: 8px 0;
              border-bottom: 1px solid var(--border-color);
            "
          >
            <span style="color: var(--text-secondary)">Average Trade:</span>
            <span id="avg-trade" class="neutral">$0.00</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              padding: 8px 0;
              border-bottom: 1px solid var(--border-color);
            "
          >
            <span style="color: var(--text-secondary)">Open P&L:</span>
            <span id="open-pnl" class="neutral">$0.00</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              padding: 8px 0;
              border-bottom: 1px solid var(--border-color);
            "
          >
            <span style="color: var(--text-secondary)">Max Drawdown:</span>
            <span id="max-drawdown" class="negative">0.00%</span>
          </div>
        </div>

        <div class="panel-header">
          <span>‚öôÔ∏è SYSTEM STATUS</span>
        </div>
        <div style="padding: 15px">
          <div
            style="
              display: flex;
              justify-content: space-between;
              padding: 8px 0;
            "
          >
            <span style="color: var(--text-secondary)">CPU Usage:</span>
            <span id="cpu-usage">--%</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              padding: 8px 0;
            "
          >
            <span style="color: var(--text-secondary)">Memory:</span>
            <span id="memory-usage">--%</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              padding: 8px 0;
            "
          >
            <span style="color: var(--text-secondary)">API Latency:</span>
            <span id="latency" class="positive">-- ms</span>
          </div>
        </div>
      </div>

      <!-- Center Panel - Active Signals -->
      <div class="panel signals-container">
        <div class="panel-header">
          <span>üì° ACTIVE ML SIGNALS</span>
          <div style="display: flex; gap: 10px">
            <button class="btn ml-btn" onclick="triggerRetraining()">
              RETRAIN
            </button>
            <button class="btn" onclick="refreshData()">REFRESH</button>
          </div>
        </div>

        <div style="flex: 1; overflow-y: auto">
          <table class="signals-table">
            <thead>
              <tr>
                <th>Coin</th>
                <th>Direction</th>
                <th>Entry</th>
                <th>Current</th>
                <th>Target</th>
                <th>Stop</th>
                <th>P&L</th>
                <th>Progress</th>
                <th>ML Conf</th>
                <th>Prediction</th>
              </tr>
            </thead>
            <tbody id="signals-tbody">
              <tr>
                <td colspan="10">
                  <div class="empty-state">
                    <div class="empty-state-icon">üß†</div>
                    <p>No active ML signals</p>
                    <p style="font-size: 11px; margin-top: 10px">
                      Training models and analyzing patterns...
                    </p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="panel-header">
          <span>üìù ACTIVITY LOG</span>
        </div>
        <div class="log-container" id="log-container">
          <!-- Logs will be inserted here -->
        </div>
      </div>

      <!-- Right Panel - Analysis -->
      <div class="panel">
        <div class="panel-header">
            <span>üìä TRADE HISTORY</span>
        </div>
        <div style="padding: 15px; height: calc(100% - 45px); overflow-y: auto;">
            <table style="width: 100%; font-size: 11px;">
                <thead>
                    <tr style="border-bottom: 2px solid var(--border-color);">
                        <th style="text-align: left; padding: 8px 4px; color: var(--text-secondary);">COIN</th>
                        <th style="text-align: left; padding: 8px 4px; color: var(--text-secondary);">DIR</th>
                        <th style="text-align: right; padding: 8px 4px; color: var(--text-secondary);">ENTRY</th>
                        <th style="text-align: right; padding: 8px 4px; color: var(--text-secondary);">EXIT</th>
                        <th style="text-align: right; padding: 8px 4px; color: var(--text-secondary);">P&L</th>
                        <th style="text-align: left; padding: 8px 4px; color: var(--text-secondary);">REASON</th>
                    </tr>
                </thead>
                <tbody id="trade-history-tbody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            No trade history available
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Chart Modal -->
    <div id="chart-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-title" style="color: var(--accent-purple)">
            ML ANALYSIS
          </h2>
          <button class="close-btn" onclick="closeModal()">√ó</button>
        </div>
        <div class="chart-container" id="chart-container"></div>
        <div class="modal-tabs">
          <div class="modal-tab active" onclick="showTab('technical')">
            Technical
          </div>
          <div class="modal-tab" onclick="showTab('ml')">ML Analysis</div>
          <div class="modal-tab" onclick="showTab('features')">Features</div>
        </div>
        <div class="tab-content active" id="technical-tab">
          <h3 style="color: var(--accent-green); margin-bottom: 10px">
            Technical Indicators
          </h3>
          <div
            id="indicators-data"
            style="font-size: 12px; color: var(--text-secondary)"
          ></div>
        </div>
        <div class="tab-content" id="ml-tab">
          <h3 style="color: var(--accent-purple); margin-bottom: 10px">
            ML Prediction Analysis
          </h3>
          <div
            id="ml-analysis"
            style="font-size: 12px; color: var(--text-secondary)"
          ></div>
        </div>
        <div class="tab-content" id="features-tab">
          <h3 style="color: var(--accent-blue); margin-bottom: 10px">
            Feature Importance
          </h3>
          <div
            id="feature-importance"
            style="font-size: 12px; color: var(--text-secondary)"
          ></div>
        </div>
      </div>
    </div>

    <script>
      let ws;
      let chart;
      let currentSignals = [];
      let mlModelStats = {};
      let startTime = new Date();
      let logContainer = document.getElementById("log-container");

      // Initialize WebSocket
      function initWebSocket() {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${protocol}//${window.location.host}/ws`;

        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          console.log("ML WebSocket connected");
          addLog("INFO", "SYSTEM", "ML WebSocket connection established");
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            handleWebSocketMessage(data);
          } catch (e) {
            console.error("WebSocket message error:", e);
          }
        };

        ws.onclose = () => {
          console.log("WebSocket disconnected");
          addLog(
            "WARNING",
            "SYSTEM",
            "WebSocket disconnected, reconnecting..."
          );
          setTimeout(initWebSocket, 5000);
        };

        ws.onerror = (error) => {
          console.error("WebSocket error:", error);
          addLog("ERROR", "SYSTEM", "WebSocket connection error");
        };
      }

      function handleWebSocketMessage(data) {
        switch (data.type) {
          case "connection_established":
            updateModelCount(data.features?.length || 0);
            break;
          case "new_ml_signal":
            addLog(
              "INFO",
              "ML_SIGNAL",
              `New ML ${data.signal.direction} signal: ${
                data.signal.coin
              } (Pred: ${(data.ml_prediction * 100).toFixed(1)}%)`
            );
            refreshData();
            break;
          case "ml_signal_closed":
            addLog(
              "INFO",
              "ML_SIGNAL",
              `ML Signal closed: ${data.coin} - ${
                data.exit_reason
              } (Accuracy: ${(data.ml_prediction_accuracy * 100).toFixed(1)}%)`
            );
            refreshData();
            break;
          case "model_training_started":
            updateStatusDot("training");
            addLog("INFO", "ML_TRAINER", "Model retraining started");
            document.getElementById("training-status").textContent =
              "Training: Active";
            break;
          case "model_training_completed":
            updateStatusDot("running");
            addLog(
              "INFO",
              "ML_TRAINER",
              `Model training completed: ${data.models_retrained} models retrained`
            );
            document.getElementById("training-status").textContent =
              "Training: Idle";
            refreshData();
            break;
          case "ml_scan_started":
            updateStatusDot("scanning");
            addLog(
              "INFO",
              "ML_SCANNER",
              `ML scan #${data.scan_number} started (${data.models_active} models active)`
            );
            break;
          case "ml_scan_completed":
            updateStatusDot("running");
            addLog(
              "INFO",
              "ML_SCANNER",
              `ML scan completed: ${data.ml_predictions} predictions, ${data.new_signals} signals`
            );
            document.getElementById("scan-count").textContent = data.scan_count;
            break;
          case "price_update":
            updateSignalPricesLive(data.updates);
            break;
        }
      }

      function updateStatusDot(status) {
        const dot = document.getElementById("main-status-dot");
        const statusText = document.getElementById("bot-status");

        dot.className = "status-dot";

        switch (status) {
          case "training":
            dot.classList.add("training");
            statusText.textContent = "TRAINING";
            break;
          case "scanning":
            dot.classList.add("scanning");
            statusText.textContent = "SCANNING";
            break;
          default:
            statusText.textContent = "ACTIVE";
        }
      }

      function updateModelCount(count) {
        document.getElementById("models-count").textContent = count;
      }

      async function loadInitialLogs() {
        try {
          const response = await fetch("/api/logs");
          const data = await response.json();

          if (data.logs && data.logs.length > 0) {
            logContainer.innerHTML = "";
            data.logs.forEach((log) => {
              addLogFromBackend(log);
            });
          }
        } catch (error) {
          console.error("Failed to load initial logs:", error);
        }
      }

      async function loadTradeHistory() {
    try {
        const response = await fetch('/api/trades/history');
        const data = await response.json();
        
        const tbody = document.getElementById('trade-history-tbody');
        
        if (!data.trades || data.trades.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        No trade history available
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = data.trades.map(trade => {
            const pnlClass = trade.pnl_usd >= 0 ? 'positive' : 'negative';
            const dirClass = trade.direction === 'LONG' ? 'positive' : 'negative';
            
            return `
                <tr style="border-bottom: 1px solid rgba(42, 42, 42, 0.3);">
                    <td style="padding: 8px 4px; font-weight: 600; color: var(--accent-purple);">${trade.coin}</td>
                    <td style="padding: 8px 4px;">
                        <span class="${dirClass}" style="font-size: 10px; font-weight: 600;">${trade.direction}</span>
                    </td>
                    <td style="padding: 8px 4px; text-align: right;">${trade.entry_price.toFixed(4)}</td>
                    <td style="padding: 8px 4px; text-align: right;">${trade.exit_price.toFixed(4)}</td>
                    <td style="padding: 8px 4px; text-align: right;" class="${pnlClass}">
                        <div style="font-weight: 600;">$${trade.pnl_usd.toFixed(2)}</div>
                        <div style="font-size: 9px;">${trade.pnl_percentage.toFixed(1)}%</div>
                    </td>
                    <td style="padding: 8px 4px; font-size: 10px; color: var(--text-secondary);">${trade.exit_reason}</td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Failed to load trade history:', error);
    }
}

      function addLogFromBackend(logData) {
        const logEntry = document.createElement("div");
        logEntry.className = "log-entry fade-in";

        const timestamp = new Date(logData.timestamp).toLocaleTimeString();

        logEntry.innerHTML = `
        <span class="log-timestamp">[${timestamp}]</span>
        <span class="log-level log-${logData.level}">${logData.level}</span>
        <span style="color: var(--accent-purple);">[${logData.component}]</span>
        <span>${logData.message}</span>
        ${
          logData.details
            ? `<span style="color: var(--text-secondary);"> - ${logData.details}</span>`
            : ""
        }
    `;

        logContainer.insertBefore(logEntry, logContainer.firstChild);

        while (logContainer.children.length > 50) {
          logContainer.removeChild(logContainer.lastChild);
        }
      }

      async function loadSystemUptime() {
        try {
          const response = await fetch("/api/system");
          const data = await response.json();

          if (data.uptime_seconds) {
            startTime = new Date(Date.now() - data.uptime_seconds * 1000);
            document.getElementById("scan-count").textContent =
              data.scan_count || 0;
            document.getElementById("models-count").textContent =
              data.models_trained || 0;
          }
        } catch (error) {
          console.error("Failed to load system stats:", error);
        }
      }

      function addLog(level, component, message) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.className = "log-entry fade-in";
        logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-level log-${level}">${level}</span>
                <span style="color: var(--accent-purple);">[${component}]</span>
                <span>${message}</span>
            `;

        const container = document.getElementById("log-container");
        container.insertBefore(logEntry, container.firstChild);

        while (container.children.length > 50) {
          container.removeChild(container.lastChild);
        }

        document.getElementById("last-update").textContent = timestamp;
      }

      function updateUptime() {
        const now = new Date();
        const diff = now - startTime;
        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);

        document.getElementById("uptime").textContent = `${hours
          .toString()
          .padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds
          .toString()
          .padStart(2, "0")}`;
      }

      function updateRecentAlerts(alerts) {
        const alertsContainer = document.getElementById("recent-alerts");

        if (!alerts || alerts.length === 0) {
          alertsContainer.innerHTML = `
            <div style="color: var(--text-secondary); font-size: 11px">
                No recent alerts
            </div>
        `;
          return;
        }

        alertsContainer.innerHTML = alerts
          .map((alert) => {
            const pnlClass = alert.pnl_usd >= 0 ? "positive" : "negative";
            const statusBadge =
              alert.status === "active"
                ? '<span style="color: var(--accent-purple); font-weight: 600;">‚óè</span>'
                : '<span style="color: var(--text-secondary);">‚óã</span>';

            const timeAgo = formatTimeAgo(new Date(alert.timestamp));

            return `
            <div style="
                padding: 8px 0; 
                border-bottom: 1px solid rgba(42, 42, 42, 0.3);
                font-size: 11px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 2px;">
                        ${statusBadge}
                        <span style="color: var(--accent-purple); font-weight: 600;">${
                          alert.coin
                        }</span>
                        <span style="color: var(--text-secondary); font-size: 9px;">${
                          alert.direction
                        }</span>
                    </div>
                    <div style="color: var(--text-secondary); font-size: 10px;">
                        Entry: $${alert.entry_price.toFixed(4)} ‚Ä¢ ${timeAgo}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div class="${pnlClass}" style="font-weight: 600;">
                        $${alert.pnl_usd.toFixed(2)}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 9px;">
                        ${alert.confidence}%
                    </div>
                </div>
            </div>
        `;
          })
          .join("");
      }

      function formatTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);

        if (diffMins < 1) return "just now";
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        return `${diffDays}d ago`;
      }

      async function refreshData() {
    try {
        const [
            signalsResp,
            portfolioResp,
            systemResp,
            alertsResp,
            modelsResp,
        ] = await Promise.all([
            fetch("/api/signals"),
            fetch("/api/portfolio"),
            fetch("/api/system").catch(() => ({ ok: false })),
            fetch("/api/alerts"),
            fetch("/api/ml/models").catch(() => ({
                ok: false,
                json: () => ({}),
            })),
        ]);

        const signalsData = await signalsResp.json();
        const portfolioData = await portfolioResp.json();
        const systemData = systemResp.ok ? await systemResp.json() : null;
        const alertsData = await alertsResp.json();
        const modelsData = modelsResp.ok ? await modelsResp.json() : {};

        updateSignalsDisplay(signalsData.signals || []);
        updatePortfolioStats(portfolioData.portfolio || {});
        updateMLStats(signalsData.ml_metrics || {}, modelsData);       
        
        await loadTradeHistory(); // Add this here
        
        if (systemData) {
            updateSystemStats(systemData);
        }
    } catch (error) {
        console.error("Error refreshing data:", error);
        addLog("ERROR", "SYSTEM", "Failed to refresh data");
    }
}

      function updateMLStats(mlMetrics, modelsData) {
        // Update ML performance cards
        document.getElementById("ml-accuracy").textContent = `${(
          mlMetrics.avg_model_confidence * 100 || 0
        ).toFixed(1)}%`;
        document.getElementById("avg-confidence").textContent = `${(
          mlMetrics.avg_model_confidence * 100 || 0
        ).toFixed(1)}%`;
        document.getElementById("feature-quality").textContent = `${(
          mlMetrics.feature_orthogonality * 100 || 0
        ).toFixed(1)}%`;
        
      }

      function updateTopFeatures(models) {
        const featuresContainer = document.getElementById("top-features");

        // Aggregate feature importance across all models
        const allFeatures = {};
        Object.values(models).forEach((model) => {
          if (model.top_features) {
            Object.entries(model.top_features).forEach(
              ([feature, importance]) => {
                allFeatures[feature] = (allFeatures[feature] || 0) + importance;
              }
            );
          }
        });

        // Sort and take top 10
        const topFeatures = Object.entries(allFeatures)
          .sort(([, a], [, b]) => b - a)
          .slice(0, 10);

        if (topFeatures.length === 0) {
          featuresContainer.innerHTML = `
            <div style="color: var(--text-secondary); font-size: 11px">
              No feature data available
            </div>
          `;
          return;
        }

        featuresContainer.innerHTML = topFeatures
          .map(
            ([feature, importance]) => `
          <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 11px;">
            <span style="color: var(--text-secondary);">${feature.replace(
              /_/g,
              " "
            )}</span>
            <span style="color: var(--accent-purple); font-weight: 600;">${(
              importance * 100
            ).toFixed(1)}%</span>
          </div>
        `
          )
          .join("");
      }

      function updatePortfolioStats(portfolio) {
        const balance = portfolio.total_balance || 1000;
        const totalPnl = portfolio.total_pnl || 0;
        const totalTrades = portfolio.total_trades || 0;
        const winningTrades = portfolio.winning_trades || 0;
        const losingTrades = portfolio.losing_trades || 0;
        const winRate = portfolio.win_rate || 0;

        document.getElementById(
          "portfolio-balance"
        ).textContent = `$${balance.toFixed(2)}`;

        const changePercent = (totalPnl / 1000) * 100;
        const changeElement = document.getElementById("portfolio-change");
        changeElement.textContent = `${
          totalPnl >= 0 ? "+" : ""
        }${changePercent.toFixed(2)}%`;
        changeElement.className = totalPnl >= 0 ? "positive" : "negative";

        document.getElementById("active-signals").textContent =
          currentSignals.length;
        document.getElementById(
          "total-signals"
        ).textContent = `Total: ${totalTrades}`;
        document.getElementById("win-rate").textContent = `${winRate.toFixed(
          1
        )}%`;
        document.getElementById(
          "win-loss-ratio"
        ).textContent = `W: ${winningTrades} / L: ${losingTrades}`;
        document.getElementById("total-pnl").textContent = `$${totalPnl.toFixed(
          2
        )}`;
        document.getElementById(
          "pnl-percentage"
        ).textContent = `${changePercent.toFixed(2)}%`;
        document.getElementById("pnl-percentage").className =
          totalPnl >= 0 ? "positive" : "negative";

        // Update detailed metrics
        document.getElementById("best-trade").textContent = `$${(
          portfolio.best_trade || 0
        ).toFixed(2)}`;
        document.getElementById("worst-trade").textContent = `$${(
          portfolio.worst_trade || 0
        ).toFixed(2)}`;
        document.getElementById("avg-trade").textContent = `$${(
          portfolio.avg_pnl || 0
        ).toFixed(2)}`;
        document.getElementById("open-pnl").textContent = `$${(
          portfolio.open_pnl || 0
        ).toFixed(2)}`;
        document.getElementById("max-drawdown").textContent = `${(
          portfolio.max_drawdown || 0
        ).toFixed(2)}%`;

        // Update Sharpe ratio
        document.getElementById("sharpe-ratio").textContent = (
          portfolio.sharpe_ratio || 0
        ).toFixed(2);
      }

      function updateSignalsDisplay(signals) {
        currentSignals = signals;
        const tbody = document.getElementById("signals-tbody");

        if (!signals || signals.length === 0) {
          tbody.innerHTML = `
                    <tr>
                        <td colspan="10">
                            <div class="empty-state">
                                <div class="empty-state-icon">üß†</div>
                                <p>No active ML signals</p>
                                <p style="font-size: 11px; margin-top: 10px;">Training models and analyzing patterns...</p>
                            </div>
                        </td>
                    </tr>
                `;
          return;
        }

        tbody.innerHTML = signals
          .map((signal) => {
            const pnl = signal.live_pnl_usd || signal.pnl_usd || 0;
            const pnlPercent =
              signal.live_pnl_percentage || signal.pnl_percentage || 0;
            const tpProgress = signal.tp_progress || 0;
            const mlConfidence = signal.model_confidence || 0;
            const mlPrediction = signal.ml_prediction || 0;

            return `
                    <tr onclick="showChart('${signal.coin}', '${
              signal.signal_id
            }')" class="fade-in ml-signal">
                        <td style="font-weight: bold; color: var(--accent-purple);">${
                          signal.coin
                        }</td>
                        <td><span class="signal-badge badge-${signal.direction.toLowerCase()}">${
              signal.direction
            }</span></td>
                        <td>${signal.entry_price.toFixed(6)}</td>
                        <td>${(
                          signal.current_price || signal.entry_price
                        ).toFixed(6)}</td>
                        <td style="color: var(--accent-green);">${signal.take_profit.toFixed(
                          6
                        )}</td>
                        <td style="color: var(--accent-red);">${signal.stop_loss.toFixed(
                          6
                        )}</td>
                        <td class="${pnl >= 0 ? "positive" : "negative"}">
                            $${pnl.toFixed(2)}<br>
                            <small>${pnlPercent.toFixed(1)}%</small>
                        </td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${Math.min(
                                  100,
                                  Math.max(0, tpProgress)
                                )}%"></div>
                            </div>
                            <small>${tpProgress.toFixed(0)}%</small>
                        </td>
                        <td style="text-align: center;">
                            <span class="ml-confidence-badge">${(
                              mlConfidence * 100
                            ).toFixed(0)}%</span>
                        </td>
                        <td style="text-align: center; color: var(--accent-purple);">
                            ${(mlPrediction * 100).toFixed(1)}%
                        </td>
                    </tr>
                `;
          })
          .join("");
      }

      function updateSystemStats(system) {
        if (system.cpu_usage !== undefined) {
          document.getElementById(
            "cpu-usage"
          ).textContent = `${system.cpu_usage.toFixed(1)}%`;
        }
        if (system.memory_usage !== undefined) {
          document.getElementById(
            "memory-usage"
          ).textContent = `${system.memory_usage.toFixed(1)}%`;
        }
      }

      async function showChart(coin, signalId) {
        const modal = document.getElementById("chart-modal");
        modal.style.display = "block";
        document.getElementById(
          "modal-title"
        ).textContent = `${coin} ML ANALYSIS`;

        const signal = currentSignals.find((s) => s.signal_id === signalId);
        if (signal) {
          // Technical indicators tab
          document.getElementById("indicators-data").innerHTML = `
                    RSI: ${signal.indicators?.rsi || "N/A"}<br>
                    MACD: ${signal.indicators?.macd?.toFixed(6) || "N/A"}<br>
                    Volume Ratio: ${
                      signal.indicators?.volume_ratio || "N/A"
                    }<br>
                    ATR %: ${signal.indicators?.atr_percentage || "N/A"}%
                `;

          // ML analysis tab
          document.getElementById("ml-analysis").innerHTML = `
                    <strong>ML Prediction:</strong> ${(
                      signal.ml_prediction * 100 || 0
                    ).toFixed(2)}%<br>
                    <strong>Model Confidence:</strong> ${(
                      signal.model_confidence * 100 || 0
                    ).toFixed(1)}%<br>
                    <strong>Model Type:</strong> ${
                      signal.analysis_data?.model_type || "Unknown"
                    }<br>
                    <strong>Direction:</strong> ${signal.direction}<br>
                    <strong>Risk/Reward:</strong> ${
                      signal.analysis_data?.risk_reward_ratio || "N/A"
                    }<br><br>
                    <strong>ML Factors:</strong><br>
                    ${(signal.confluence_factors || [])
                      .map((f) => `‚Ä¢ ${f}`)
                      .join("<br>")}
                `;

          // Feature importance tab
          const features =
            signal.feature_importance_top3 || signal.feature_importance || {};
          document.getElementById("feature-importance").innerHTML =
            Object.keys(features).length > 0
              ? Object.entries(features)
                  .sort(([, a], [, b]) => b - a)
                  .map(
                    ([feature, importance]) =>
                      `<div class="feature-tag">${feature.replace(
                        /_/g,
                        " "
                      )}: ${(importance * 100).toFixed(1)}%</div>`
                  )
                  .join("")
              : "No feature importance data available";
        }
      }

      function showTab(tabName) {
        // Hide all tabs
        document
          .querySelectorAll(".modal-tab")
          .forEach((tab) => tab.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((content) => content.classList.remove("active"));

        // Show selected tab
        document
          .querySelector(
            `.modal-tab:nth-child(${
              tabName === "technical" ? 1 : tabName === "ml" ? 2 : 3
            })`
          )
          .classList.add("active");
        document.getElementById(`${tabName}-tab`).classList.add("active");
      }

      function closeModal() {
        document.getElementById("chart-modal").style.display = "none";
      }

      async function triggerRetraining() {
        try {
          const response = await fetch("/api/control/retrain", {
            method: "POST",
          });
          const data = await response.json();
          addLog("INFO", "ML_TRAINER", data.message);
        } catch (error) {
          addLog("ERROR", "ML_TRAINER", "Failed to trigger retraining");
        }
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", async () => {
        await loadSystemUptime();
        await loadInitialLogs();
        initWebSocket();
        refreshData();

        setInterval(updateUptime, 1000);
        setInterval(refreshData, 60000); // Refresh every minute
        setInterval(loadSystemUptime, 30000);

        // Simulate system stats
        setInterval(() => {
          document.getElementById("cpu-usage").textContent = `${(
            Math.random() * 30 +
            10
          ).toFixed(1)}%`;
          document.getElementById("memory-usage").textContent = `${(
            Math.random() * 40 +
            30
          ).toFixed(1)}%`;
          document.getElementById("latency").textContent = `${Math.floor(
            Math.random() * 50 + 20
          )} ms`;
        }, 5000);
      });

      // Close modal on outside click
      window.onclick = (event) => {
        const modal = document.getElementById("chart-modal");
        if (event.target === modal) {
          closeModal();
        }
      };
    </script>
  </body>
</html>
