<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ML Crypto Trading Bot v3.0</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --bg-primary: #0a0a0a;
        --bg-secondary: #141414;
        --bg-tertiary: #1a1a1a;
        --border-color: #2a2a2a;
        --text-primary: #ffffff;
        --text-secondary: #a0a0a0;
        --accent-green: #00ff88;
        --accent-red: #ff3366;
        --accent-yellow: #ffaa00;
        --accent-blue: #00aaff;
        --accent-purple: #8b5cf6;
      }

      body {
        font-family: "SF Mono", "Monaco", "Inconsolata", "Fira Code", monospace;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-size: 13px;
        overflow-x: hidden;
        line-height: 1.4;
      }

      /* Header */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: linear-gradient(
          90deg,
          var(--bg-secondary) 0%,
          var(--bg-tertiary) 100%
        );
        border-bottom: 2px solid var(--border-color);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
      }

      .header h1 {
        font-size: 18px;
        color: var(--accent-purple);
        font-weight: 600;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .ml-badge {
        background: linear-gradient(
          135deg,
          var(--accent-purple),
          var(--accent-blue)
        );
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 9px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-bar {
        display: flex;
        align-items: center;
        gap: 20px;
        font-size: 12px;
      }

      .status-item {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 4px;
        border: 1px solid var(--border-color);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--accent-green);
        animation: pulse 2s infinite;
      }

      .status-dot.training {
        background: var(--accent-purple);
        animation: pulse 1s infinite;
      }

      .status-dot.scanning {
        background: var(--accent-blue);
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7);
        }
        50% {
          opacity: 0.6;
          box-shadow: 0 0 0 6px rgba(0, 255, 136, 0);
        }
      }

      /* Main Layout */
      .main-container {
        display: grid;
        grid-template-columns: 320px 1fr 300px;
        height: calc(100vh - 60px);
        gap: 1px;
        background: var(--border-color);
      }

      .panel {
        background: var(--bg-secondary);
        overflow-y: auto;
        overflow-x: hidden;
      }

      .panel-header {
        padding: 10px 15px;
        background: linear-gradient(
          90deg,
          var(--bg-tertiary) 0%,
          var(--bg-secondary) 100%
        );
        border-bottom: 1px solid var(--border-color);
        font-size: 11px;
        font-weight: 600;
        color: var(--accent-green);
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .panel-header.ml-header {
        color: var(--accent-purple);
      }

      /* Stats Cards */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        padding: 15px;
      }

      .stat-card {
        background: linear-gradient(
          135deg,
          var(--bg-tertiary) 0%,
          var(--bg-primary) 100%
        );
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 12px;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 255, 136, 0.1);
        border-color: var(--accent-green);
      }

      .stat-card.ml-card {
        border-color: rgba(139, 92, 246, 0.3);
      }

      .stat-card.ml-card:hover {
        border-color: var(--accent-purple);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1);
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(
          90deg,
          transparent,
          var(--accent-green),
          transparent
        );
        animation: scan 3s linear infinite;
      }

      .stat-card.ml-card::before {
        background: linear-gradient(
          90deg,
          transparent,
          var(--accent-purple),
          transparent
        );
      }

      @keyframes scan {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      .stat-label {
        font-size: 10px;
        color: var(--text-secondary);
        text-transform: uppercase;
        margin-bottom: 5px;
        letter-spacing: 0.5px;
      }

      .stat-value {
        font-size: 18px;
        font-weight: bold;
        color: var(--text-primary);
        margin-bottom: 3px;
      }

      .stat-change {
        font-size: 11px;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      /* Color Classes */
      .positive {
        color: var(--accent-green);
      }
      .negative {
        color: var(--accent-red);
      }
      .neutral {
        color: var(--accent-yellow);
      }
      .ml-accent {
        color: var(--accent-purple);
      }

      /* Signals Section */
      .signals-container {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .signals-table {
        width: 100%;
        border-collapse: collapse;
      }

      .signals-table thead {
        background: var(--bg-tertiary);
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .signals-table th {
        padding: 10px;
        text-align: left;
        font-size: 10px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 1px;
        border-bottom: 2px solid var(--border-color);
      }

      .signals-table tbody tr {
        border-bottom: 1px solid var(--border-color);
        transition: all 0.2s ease;
      }

      .signals-table tbody tr:hover {
        background: rgba(0, 255, 136, 0.05);
      }

      .signals-table tbody tr.ml-signal:hover {
        background: rgba(139, 92, 246, 0.05);
      }

      .signals-table td {
        padding: 12px 10px;
        font-size: 12px;
      }

      .signal-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-weight: 600;
        font-size: 10px;
        text-transform: uppercase;
      }

      .badge-long {
        background: rgba(0, 255, 136, 0.2);
        color: var(--accent-green);
        border: 1px solid var(--accent-green);
      }

      .badge-short {
        background: rgba(255, 51, 102, 0.2);
        color: var(--accent-red);
        border: 1px solid var(--accent-red);
      }

      .ml-confidence-badge {
        background: rgba(139, 92, 246, 0.2);
        color: var(--accent-purple);
        border: 1px solid var(--accent-purple);
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 9px;
        font-weight: 600;
      }

      /* Progress Bars */
      .progress-bar {
        width: 100%;
        height: 4px;
        background: var(--bg-tertiary);
        border-radius: 2px;
        overflow: hidden;
        margin-top: 4px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--accent-green),
          var(--accent-blue)
        );
        transition: width 0.3s ease;
      }

      /* Logs */
      .log-container {
        max-height: 250px;
        overflow-y: auto;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        margin: 15px;
        padding: 10px;
        font-family: monospace;
        font-size: 11px;
      }

      .log-entry {
        padding: 4px 0;
        border-bottom: 1px solid rgba(42, 42, 42, 0.5);
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .log-timestamp {
        color: var(--text-secondary);
        font-size: 10px;
      }

      .log-level {
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 9px;
        font-weight: 600;
      }

      .log-INFO {
        background: rgba(0, 255, 136, 0.2);
        color: var(--accent-green);
      }
      .log-WARNING {
        background: rgba(255, 170, 0, 0.2);
        color: var(--accent-yellow);
      }
      .log-ERROR {
        background: rgba(255, 51, 102, 0.2);
        color: var(--accent-red);
      }

      /* Buttons */
      .btn {
        padding: 8px 16px;
        background: linear-gradient(
          135deg,
          var(--accent-green),
          var(--accent-blue)
        );
        border: none;
        border-radius: 4px;
        color: var(--bg-primary);
        font-weight: 600;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn.ml-btn {
        background: linear-gradient(
          135deg,
          var(--accent-purple),
          var(--accent-blue)
        );
      }

      .btn.ml-btn:hover {
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.3;
      }

      /* Loading Spinner */
      .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid var(--border-color);
        border-left-color: var(--accent-green);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: var(--bg-primary);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
      }

      /* Responsive */
      @media (max-width: 1200px) {
        .main-container {
          grid-template-columns: 280px 1fr 260px;
        }
      }

      @media (max-width: 900px) {
        .main-container {
          grid-template-columns: 1fr;
          grid-template-rows: auto 1fr auto;
        }
      }

      /* Animations */
      .fade-in {
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>
        <span style="font-size: 24px">üß†</span>
        ML CRYPTO TRADING BOT v3.0
        <span class="ml-badge">Machine Learning</span>
      </h1>
      <div class="status-bar">
        <div class="status-item">
          <div class="status-dot" id="main-status-dot"></div>
          <span id="bot-status">ACTIVE</span>
        </div>
        <div class="status-item">
          <span>POSITIONS:</span>
          <span id="active-positions" style="color: var(--accent-purple)"
            >0</span
          >
        </div>
        <div class="status-item">
          <span>UPTIME:</span>
          <span id="uptime" style="color: var(--accent-green)">00:00:00</span>
        </div>
        <div class="status-item">
          <span>SCANS:</span>
          <span id="scan-count" style="color: var(--accent-blue)">0</span>
        </div>
        <div class="status-item">
          <span>LAST UPDATE:</span>
          <span id="last-update" style="color: var(--accent-yellow)"
            >--:--:--</span
          >
        </div>
      </div>
    </div>

    <div class="main-container">
      <!-- Left Panel - Portfolio Stats -->
      <div class="panel">
        <div class="panel-header">
          <span>üìä PORTFOLIO OVERVIEW</span>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total Balance</div>
            <div class="stat-value" id="portfolio-balance">$0.00</div>
            <div class="stat-change" id="portfolio-change-container">
              <span id="portfolio-change">+0.00%</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Active Positions</div>
            <div class="stat-value" id="active-signals">0</div>
            <div class="stat-change neutral">Max: 8</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Win Rate</div>
            <div class="stat-value" id="win-rate">0.0%</div>
            <div class="stat-change" id="win-loss-ratio">W: 0 / L: 0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total P&L</div>
            <div class="stat-value" id="total-pnl">$0.00</div>
            <div class="stat-change" id="pnl-percentage">0.00%</div>
          </div>
        </div>

        <div class="panel-header ml-header">
          <span>üß† ML PERFORMANCE</span>
        </div>
        <div class="stats-grid">
          <div class="stat-card ml-card">
            <div class="stat-label">Model Confidence</div>
            <div class="stat-value ml-accent" id="avg-confidence">0.0%</div>
            <div class="stat-change neutral">Min: 65%</div>
          </div>
          <div class="stat-card ml-card">
            <div class="stat-label">Predictions Made</div>
            <div class="stat-value ml-accent" id="predictions-count">0</div>
            <div class="stat-change neutral">RF Models</div>
          </div>
          <div class="stat-card ml-card">
            <div class="stat-label">Features Used</div>
            <div class="stat-value ml-accent" id="feature-count">15</div>
            <div class="stat-change neutral">Orthogonalized</div>
          </div>
          <div class="stat-card ml-card">
            <div class="stat-label">Training Status</div>
            <div class="stat-value ml-accent" id="training-status">Ready</div>
            <div class="stat-change neutral" id="models-trained">0 Models</div>
          </div>
        </div>

        <div class="panel-header">
          <span>üìà PERFORMANCE METRICS</span>
        </div>
        <div style="padding: 15px">
          <div
            style="
              display: flex;
              justify-content: space-between;
              padding: 8px 0;
              border-bottom: 1px solid var(--border-color);
            "
          >
            <span style="color: var(--text-secondary)">Real Balance:</span>
            <span id="real-balance" class="neutral">$0.00</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              padding: 8px 0;
              border-bottom: 1px solid var(--border-color);
            "
          >
            <span style="color: var(--text-secondary)">Available:</span>
            <span id="available-balance" class="neutral">$0.00</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              padding: 8px 0;
              border-bottom: 1px solid var(--border-color);
            "
          >
            <span style="color: var(--text-secondary)">Open P&L:</span>
            <span id="open-pnl" class="neutral">$0.00</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              padding: 8px 0;
              border-bottom: 1px solid var(--border-color);
            "
          >
            <span style="color: var(--text-secondary)">Max Drawdown:</span>
            <span id="max-drawdown" class="negative">0.00%</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              padding: 8px 0;
              border-bottom: 1px solid var(--border-color);
            "
          >
            <span style="color: var(--text-secondary)">Leverage:</span>
            <span class="neutral">15x</span>
          </div>
        </div>

        <div class="panel-header">
          <span>‚öôÔ∏è SYSTEM STATUS</span>
        </div>
        <div style="padding: 15px">
          <div
            style="
              display: flex;
              justify-content: space-between;
              padding: 8px 0;
            "
          >
            <span style="color: var(--text-secondary)">CPU Usage:</span>
            <span id="cpu-usage">--%</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              padding: 8px 0;
            "
          >
            <span style="color: var(--text-secondary)">Memory:</span>
            <span id="memory-usage">--%</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              padding: 8px 0;
            "
          >
            <span style="color: var(--text-secondary)">Running:</span>
            <span id="is-running" class="positive">Yes</span>
          </div>
        </div>
      </div>

      <!-- Center Panel - Active Signals -->
      <div class="panel signals-container">
        <div class="panel-header">
          <span>üì° ACTIVE ML SIGNALS</span>
          <div style="display: flex; gap: 10px">
            <button class="btn ml-btn" onclick="forceRescan()">SCAN NOW</button>
            <button class="btn" onclick="refreshData()">REFRESH</button>
          </div>
        </div>

        <div style="flex: 1; overflow-y: auto">
          <table class="signals-table">
            <thead>
              <tr>
                <th>Coin</th>
                <th>Direction</th>
                <th>Entry</th>
                <th>Current</th>
                <th>Target</th>
                <th>Stop</th>
                <th>Live P&L</th>
                <th>ML Conf</th>
                <th>Size</th>
              </tr>
            </thead>
            <tbody id="signals-tbody">
              <tr>
                <td colspan="9">
                  <div class="empty-state">
                    <div class="empty-state-icon">üß†</div>
                    <p>No active ML signals</p>
                    <p style="font-size: 11px; margin-top: 10px">
                      Scanning markets for opportunities...
                    </p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="panel-header">
          <span>üìù ACTIVITY LOG</span>
        </div>
        <div class="log-container" id="log-container">
          <!-- Logs will be inserted here -->
        </div>
      </div>

      <!-- Right Panel - Trade History -->
      <div class="panel">
        <div class="panel-header">
          <span>üìä TRADE HISTORY</span>
        </div>
        <div style="padding: 15px; height: calc(50% - 45px); overflow-y: auto">
          <table style="width: 100%; font-size: 11px">
            <thead>
              <tr style="border-bottom: 2px solid var(--border-color)">
                <th
                  style="
                    text-align: left;
                    padding: 8px 4px;
                    color: var(--text-secondary);
                  "
                >
                  COIN
                </th>
                <th
                  style="
                    text-align: left;
                    padding: 8px 4px;
                    color: var(--text-secondary);
                  "
                >
                  DIR
                </th>
                <th
                  style="
                    text-align: right;
                    padding: 8px 4px;
                    color: var(--text-secondary);
                  "
                >
                  P&L
                </th>
                <th
                  style="
                    text-align: left;
                    padding: 8px 4px;
                    color: var(--text-secondary);
                  "
                >
                  EXIT
                </th>
              </tr>
            </thead>
            <tbody id="trade-history-tbody">
              <tr>
                <td
                  colspan="4"
                  style="
                    text-align: center;
                    padding: 20px;
                    color: var(--text-secondary);
                  "
                >
                  No trade history available
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="panel-header">
          <span>üéØ SUPPORTED COINS</span>
        </div>
        <div style="padding: 15px; height: calc(50% - 45px); overflow-y: auto">
          <div id="coins-list" style="display: flex; flex-wrap: wrap; gap: 6px">
            <!-- Coins will be populated here -->
          </div>
        </div>
      </div>
    </div>

    <script>
      let ws;
      let currentSignals = [];
      let startTime = new Date();
      let logContainer = document.getElementById("log-container");

      // List of supported coins (from your Python code)
      const SUPPORTED_COINS = [
        "WLFI",
        "DOGE",
        "BONK",
        "FLOKI",
        "LINK",
        "PEPE",
        "NEAR",
        "TIA",
        "ARB",
        "APT",
        "TAO",
        "FET",
        "SUI",
        "SEI",
        "OP",
        "LDO",
        "SHIB",
        "BOME",
        "PENDLE",
        "JUP",
        "LINEA",
        "UB",
        "CGPT",
        "POPCAT",
        "WIF",
        "OL",
        "JASMY",
        "BLUR",
        "GMX",
        "COMP",
        "CRV",
        "TRUMP",
        "1INCH",
        "SUSHI",
        "YFI",
        "MOVE",
      ];

      // Initialize WebSocket
      function initWebSocket() {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${protocol}//${window.location.host}/ws`;

        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          console.log("WebSocket connected");
          addLog("INFO", "SYSTEM", "WebSocket connection established");
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            handleWebSocketMessage(data);
          } catch (e) {
            console.error("WebSocket message error:", e);
          }
        };

        ws.onclose = () => {
          console.log("WebSocket disconnected");
          addLog(
            "WARNING",
            "SYSTEM",
            "WebSocket disconnected, reconnecting..."
          );
          setTimeout(initWebSocket, 5000);
        };

        ws.onerror = (error) => {
          console.error("WebSocket error:", error);
          addLog("ERROR", "SYSTEM", "WebSocket connection error");
        };
      }

      function handleWebSocketMessage(data) {
        switch (data.type) {
          case "new_signal":
            addLog(
              "INFO",
              "SIGNAL",
              `New ${data.signal.direction} signal: ${data.signal.coin}`
            );
            refreshData();
            break;
          case "signal_closed":
            addLog(
              "INFO",
              "SIGNAL",
              `Signal closed: ${data.coin} - ${data.exit_reason}`
            );
            refreshData();
            break;
          case "scan_completed":
            updateStatusDot("active");
            addLog("INFO", "SCANNER", `Scan #${data.scan_count} completed`);
            document.getElementById("scan-count").textContent = data.scan_count;
            break;
        }
      }

      function updateStatusDot(status) {
        const dot = document.getElementById("main-status-dot");
        const statusText = document.getElementById("bot-status");

        dot.className = "status-dot";

        switch (status) {
          case "scanning":
            dot.classList.add("scanning");
            statusText.textContent = "SCANNING";
            break;
          default:
            statusText.textContent = "ACTIVE";
        }
      }

      function addLog(level, component, message) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.className = "log-entry fade-in";
        logEntry.innerHTML = `
          <span class="log-timestamp">[${timestamp}]</span>
          <span class="log-level log-${level}">${level}</span>
          <span style="color: var(--accent-purple);">[${component}]</span>
          <span>${message}</span>
        `;

        const container = document.getElementById("log-container");
        container.insertBefore(logEntry, container.firstChild);

        while (container.children.length > 50) {
          container.removeChild(container.lastChild);
        }

        document.getElementById("last-update").textContent = timestamp;
      }

      function updateUptime() {
        const now = new Date();
        const diff = now - startTime;
        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);

        document.getElementById("uptime").textContent = `${hours
          .toString()
          .padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds
          .toString()
          .padStart(2, "0")}`;
      }

      async function loadTradeHistory() {
        try {
          const response = await fetch("/api/trades/history");
          const data = await response.json();

          const tbody = document.getElementById("trade-history-tbody");

          if (!data.trades || data.trades.length === 0) {
            tbody.innerHTML = `
              <tr>
                <td colspan="4" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                  No trade history available
                </td>
              </tr>
            `;
            return;
          }

          // Show last 10 trades
          tbody.innerHTML = data.trades
            .slice(0, 10)
            .map((trade) => {
              const pnlClass = trade.pnl_usd >= 0 ? "positive" : "negative";
              const dirClass =
                trade.direction === "LONG" ? "positive" : "negative";

              return `
              <tr style="border-bottom: 1px solid rgba(42, 42, 42, 0.3);">
                <td style="padding: 6px 4px; font-weight: 600;">${trade.coin.replace(
                  "USDT",
                  ""
                )}</td>
                <td style="padding: 6px 4px;">
                  <span class="${dirClass}" style="font-size: 10px;">${
                trade.direction[0]
              }</span>
                </td>
                <td style="padding: 6px 4px; text-align: right;" class="${pnlClass}">
                  <div style="font-weight: 600;">$${trade.pnl_usd.toFixed(
                    2
                  )}</div>
                  <div style="font-size: 9px;">${trade.pnl_percentage.toFixed(
                    1
                  )}%</div>
                </td>
                <td style="padding: 6px 4px; font-size: 9px; color: var(--text-secondary);">${
                  trade.exit_reason
                }</td>
              </tr>
            `;
            })
            .join("");
        } catch (error) {
          console.error("Failed to load trade history:", error);
        }
      }

      async function refreshData() {
        try {
          const [signalsResp, portfolioResp, systemResp] = await Promise.all([
            fetch("/api/signals"),
            fetch("/api/portfolio"),
            fetch("/api/system"),
          ]);

          const signalsData = await signalsResp.json();
          const portfolioData = await portfolioResp.json();
          const systemData = await systemResp.json();

          updateSignalsDisplay(signalsData.signals || []);
          updatePortfolioStats(portfolioData.portfolio || {});
          updateSystemStats(systemData);

          await loadTradeHistory();
        } catch (error) {
          console.error("Error refreshing data:", error);
          addLog("ERROR", "SYSTEM", "Failed to refresh data");
        }
      }

      function updatePortfolioStats(portfolio) {
        // Update balance info
        const realBalance = portfolio.real_balance || 0;
        const availableBalance = portfolio.available_balance || 0;
        const openPnl = portfolio.open_pnl || 0;
        const totalPnl = portfolio.total_pnl || 0;
        const winRate = portfolio.win_rate || 0;
        const winningTrades = portfolio.winning_trades || 0;
        const losingTrades = portfolio.losing_trades || 0;
        const maxDrawdown = portfolio.max_drawdown || 0;

        document.getElementById(
          "portfolio-balance"
        ).textContent = `$${realBalance.toFixed(2)}`;
        document.getElementById(
          "real-balance"
        ).textContent = `$${realBalance.toFixed(2)}`;
        document.getElementById(
          "available-balance"
        ).textContent = `$${availableBalance.toFixed(2)}`;
        document.getElementById("open-pnl").textContent = `$${openPnl.toFixed(
          2
        )}`;
        document.getElementById("open-pnl").className =
          openPnl >= 0 ? "positive" : "negative";

        const changePercent =
          realBalance > 0 ? (totalPnl / realBalance) * 100 : 0;
        const changeElement = document.getElementById("portfolio-change");
        changeElement.textContent = `${
          totalPnl >= 0 ? "+" : ""
        }${changePercent.toFixed(2)}%`;
        changeElement.className = totalPnl >= 0 ? "positive" : "negative";

        document.getElementById("win-rate").textContent = `${winRate.toFixed(
          1
        )}%`;
        document.getElementById(
          "win-loss-ratio"
        ).textContent = `W: ${winningTrades} / L: ${losingTrades}`;
        document.getElementById("total-pnl").textContent = `$${totalPnl.toFixed(
          2
        )}`;
        document.getElementById(
          "pnl-percentage"
        ).textContent = `${changePercent.toFixed(2)}%`;
        document.getElementById("pnl-percentage").className =
          totalPnl >= 0 ? "positive" : "negative";
        document.getElementById(
          "max-drawdown"
        ).textContent = `${maxDrawdown.toFixed(2)}%`;
      }

      function updateSignalsDisplay(signals) {
        currentSignals = signals;
        const tbody = document.getElementById("signals-tbody");

        document.getElementById("active-signals").textContent = signals.length;
        document.getElementById("active-positions").textContent =
          signals.length;

        if (!signals || signals.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="9">
                <div class="empty-state">
                  <div class="empty-state-icon">üß†</div>
                  <p>No active ML signals</p>
                  <p style="font-size: 11px; margin-top: 10px;">
                    Scanning markets for opportunities...
                  </p>
                </div>
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = signals
          .map((signal) => {
            // Use the live P&L from backend
            const pnl = signal.live_pnl_usd || 0;
            const pnlPercent = signal.live_pnl_percentage || 0;
            const mlConfidence =
              signal.model_confidence || signal.confidence / 100 || 0;
            const positionValue = signal.position_value || 0;

            // Normalize coin name (remove USDT if present)
            const coinDisplay = signal.coin.replace("USDT", "");

            return `
            <tr class="fade-in ml-signal">
              <td style="font-weight: bold; color: var(--accent-purple);">${coinDisplay}</td>
              <td><span class="signal-badge badge-${signal.direction.toLowerCase()}">${
              signal.direction
            }</span></td>
              <td>${signal.entry_price.toFixed(6)}</td>
              <td>${(signal.current_price || signal.entry_price).toFixed(
                6
              )}</td>
              <td style="color: var(--accent-green);">${signal.take_profit.toFixed(
                6
              )}</td>
              <td style="color: var(--accent-red);">${signal.stop_loss.toFixed(
                6
              )}</td>
              <td class="${pnl >= 0 ? "positive" : "negative"}">
                <div style="font-weight: 600;">$${pnl.toFixed(2)}</div>
                <div style="font-size: 10px;">${pnlPercent.toFixed(1)}%</div>
              </td>
              <td style="text-align: center;">
                <span class="ml-confidence-badge">${(
                  mlConfidence * 100
                ).toFixed(0)}%</span>
              </td>
              <td style="text-align: center;">
                <div style="font-size: 11px;">$${positionValue.toFixed(2)}</div>
              </td>
            </tr>
          `;
          })
          .join("");

        // Calculate average confidence for ML stats
        if (signals.length > 0) {
          const avgConfidence =
            signals.reduce(
              (sum, s) => sum + (s.model_confidence || s.confidence / 100 || 0),
              0
            ) / signals.length;
          document.getElementById("avg-confidence").textContent = `${(
            avgConfidence * 100
          ).toFixed(1)}%`;
        }
      }

      function updateSystemStats(system) {
        if (system.cpu_usage !== undefined) {
          document.getElementById(
            "cpu-usage"
          ).textContent = `${system.cpu_usage.toFixed(1)}%`;
        }
        if (system.memory_usage !== undefined) {
          document.getElementById(
            "memory-usage"
          ).textContent = `${system.memory_usage.toFixed(1)}%`;
        }
        if (system.is_running !== undefined) {
          document.getElementById("is-running").textContent = system.is_running
            ? "Yes"
            : "No";
          document.getElementById("is-running").className = system.is_running
            ? "positive"
            : "negative";
        }
        if (system.scan_count !== undefined) {
          document.getElementById("scan-count").textContent = system.scan_count;
          document.getElementById("predictions-count").textContent =
            system.scan_count;
        }

        // Update uptime if provided
        if (system.uptime_seconds) {
          startTime = new Date(Date.now() - system.uptime_seconds * 1000);
        }
      }

      function displaySupportedCoins() {
        const coinsList = document.getElementById("coins-list");
        coinsList.innerHTML = SUPPORTED_COINS.map((coin) => {
          return `<span style="
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: var(--accent-purple);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
          ">${coin}</span>`;
        }).join("");
      }

      async function forceRescan() {
        try {
          addLog("INFO", "SCANNER", "Triggering manual scan...");
          // Optionally, you can add an API endpoint to trigger scan manually
          refreshData();
        } catch (error) {
          addLog("ERROR", "SCANNER", "Failed to trigger scan");
        }
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", async () => {
        displaySupportedCoins();
        initWebSocket();
        refreshData();

        setInterval(updateUptime, 1000);
        setInterval(refreshData, 30000); // Refresh every 30 seconds

        // Update system stats periodically
        setInterval(async () => {
          try {
            const response = await fetch("/api/system");
            const data = await response.json();
            updateSystemStats(data);
          } catch (error) {
            console.error("Failed to fetch system stats:", error);
          }
        }, 10000);
      });
    </script>
  </body>
</html>
